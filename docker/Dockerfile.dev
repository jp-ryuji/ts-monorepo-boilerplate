FROM node:22-alpine AS base

RUN apk add --no-cache curl
RUN corepack enable && corepack prepare pnpm@9.0.0 --activate

WORKDIR /app

# Copy manifests
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/api/package.json apps/api/
COPY apps/web/package.json apps/web/

RUN pnpm install --frozen-lockfile

# Copy all
COPY . .

# Development stage
FROM base AS development

# ARG for specifying which service to run
ARG SERVICE_NAME
ENV SERVICE_NAME=${SERVICE_NAME}

# Run specific service based on the argument
CMD ["sh", "-c", "if [ \"$SERVICE_NAME\" = \"api\" ]; then pnpm --filter api start:dev; elif [ \"$SERVICE_NAME\" = \"web\" ]; then pnpm --filter web dev; else pnpm dev; fi"]